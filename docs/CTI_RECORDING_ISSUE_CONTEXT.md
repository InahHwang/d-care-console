# CTI 녹취 이슈 분석 컨텍스트 (2026-02-21)

## 문제 요약

SK브로드밴드 CTI 착신녹취에서 EVT_READY_SERVICE(Svc=8, 0x0304) 이벤트가 일자별로 불규칙하게 발생하여 녹취 성공률 편차가 큼.

## 핵심 발견

### 1. 두 가지 녹취 경로
- **Svc=8 경로 (정상)**: 서버가 EVT_READY_SERVICE 전송 → IMS_TermRec_Start() 호출 → 거의 100% 성공
- **Svc=9 경로 (보조)**: 통화 연결 시 직접 IMS_TermRec_Start() 호출 → 대부분 0x800D(서비스 준비 상태가 아님) 실패

### 2. API 문서 근거 (SKBOpenAPI_사용설명서_C#_1.1.txt, 6741~6762줄)
> "착신녹취가 가능할 경우, OpenAPI 서버에서는 READY 이벤트를 클라이언트에 전송하게 되며, 가입자는 READY 이벤트를 수신한 경우에만 착신녹취를 요청할 수 있다."

- 0x800D = API_FC_NOT_READY = "서비스 준비 상태가 아님" → READY 안 왔는데 Start 호출하면 정상적으로 거부됨
- **문제는 서버가 왜 일부 통화에서만 READY를 보내는지** → SK에 문의 필요

### 3. 일자별 EVT_READY_SERVICE 발생률
| 날짜 | 통화수 | Svc=8 발생 | 비율 | 비고 |
|------|--------|-----------|------|------|
| 01/28 | 23 | 18 | 78% | 0x800D 없음 |
| 02/07 | 17 | 3 | 18% | 0x800D 없음 |
| 02/09 | 42 | 34 | 81% | 0x800D 7건 |
| 02/11 | 35 | 4 | 11% | 0x800D 29건 |
| 02/16 | 13 | 12 | 92% | 0x800D 5건 (4건은 Svc=8 백업 성공) |
| 02/20 | 40 | 10 | 25% | 0x800D 29건 |

### 4. 2/16 동시착신 중복 이슈 (해결됨)
- 070+031 동시착신 시 Svc=7 ring이 두 번 발생 → IncomingCall 두 번 전송 → DB 중복 레코드
- **수정**: CTIWorker.cs에서 1초 이내 동일 발신번호 ring은 무시 (커밋 9c91ba3)

## 관련 파일
- `CTIBridge/CTIWorker.cs` - CTI 워커 서비스 (녹취 로직)
  - 1052~1069줄: Svc=9 직접 녹취 시도
  - 1425~1448줄: EVT_READY_SERVICE 수신 시 녹취 시작
  - 984~1024줄: 동시착신 중복 방지 (수정 완료)
- `src/app/api/v2/cti/call-logs/route.ts` - 통화 상태 업데이트 API
- `src/app/api/v2/cti/incoming-call/route.ts` - 수신 통화 기록 생성 API
- `docs/SKBOpenAPI_사용설명서_C#_1.1.txt` - SK CTI API 문서
- `docs/cti-*.log` - 일자별 CTI 로그 파일

## SK브로드밴드 문의 내용 (2026-02-21 접수)
1. EVT_READY_SERVICE 발생 조건 (녹취 채널 수 제한? 서버 부하?)
2. 모든 착신 통화에 대해 발생하도록 설정 가능 여부
3. 계정별 녹취 채널 수/라이선스 현황

## 미완료 작업
- [ ] SK 답변 수신 후 조치 (답변 내용에 따라 CTIBridge 코드 수정 또는 서비스 설정 변경)
- [ ] DB에 쌓인 ringing 유령 레코드 정리 (사용자 "나중에" 요청)
- [ ] 2/19+ 빈 callerNumber 녹취 백업 무한 재시도 버그 확인
