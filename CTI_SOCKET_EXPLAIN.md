# Socket.IO μ„λ²„ μ΅΄μ¬ ν™•μΈκ³Ό λΈλ΅λ“μΊμ¤νΈ μ‰½κ² μ΄ν•΄ν•κΈ°

## π  λΉ„μ λ΅ μ΄ν•΄ν•κΈ°

### μƒν™©: μ „ν™”κ°€ μ™”λ”λ° μ•„λ¬΄λ„ μ—†μΌλ©΄?

```
μƒν™© 1: μ§‘μ— μ‚¬λμ΄ μ—†μ
  μ „ν™”κ°€ μ΄ β†’ μ§‘μ— μ‚¬λ μ—†μ β†’ λ©”μ‹μ§€ μ „λ‹¬ λ»ν•¨ β

μƒν™© 2: μ§‘μ— μ‚¬λμ΄ μμ
  μ „ν™”κ°€ μ΄ β†’ μ§‘μ— μ‚¬λ μμ β†’ λ©”μ‹μ§€ μ „λ‹¬ μ„±κ³µ β…
```

**Socket.IOλ„ λ§μ°¬κ°€μ§€μ…λ‹λ‹¤:**

```
μƒν™© 1: Socket.IO μ„λ²„κ°€ μ—†μ
  CID μμ‹  β†’ Socket.IO μ„λ²„ μ—†μ β†’ λΈλ΅λ“μΊμ¤νΈ λ»ν•¨ β

μƒν™© 2: Socket.IO μ„λ²„κ°€ μμ
  CID μμ‹  β†’ Socket.IO μ„λ²„ μμ β†’ λΈλ΅λ“μΊμ¤νΈ μ„±κ³µ β…
```

---

## π“΅ Socket.IO μ„λ²„ μ΅΄μ¬ ν™•μΈ (`global.io` μ²΄ν¬)

### 1. `global.io`λ€?

**μ‰½κ² λ§ν•λ©΄:**
- Socket.IO μ„λ²„λ¥Ό μ €μ¥ν•΄λ‘λ” "μƒμ"
- μ „μ—­ λ³€μ (λ¨λ“  κ³³μ—μ„ μ‚¬μ© κ°€λ¥)
- μ„λ²„κ°€ μ‹μ‘λλ©΄ μ΄ μƒμμ— μ €μ¥λ¨

**μ½”λ“λ΅ λ³΄λ©΄:**
```javascript
// Socket.IO μ„λ²„κ°€ μ‹μ‘λ  λ• (api/socket/route.ts)
const io = new ServerIO(httpServer);
(global as any).io = io;  // β† μ—¬κΈ°μ„ "μƒμ"μ— μ €μ¥!

// λ‹¤λ¥Έ κ³³μ—μ„ μ‚¬μ©ν•  λ• (api/cti/incoming-call/route.ts)
if (global.io) {  // β† "μƒμ"μ— λ­κ°€ μλ”μ§€ ν™•μΈ!
  // μ„λ²„κ°€ μμΌλ©΄ λΈλ΅λ“μΊμ¤νΈ!
}
```

### 2. μ™ ν™•μΈν•΄μ•Ό ν•λ‚?

**λ§μ•½ Socket.IO μ„λ²„κ°€ μ—†λ‹¤λ©΄?**
```javascript
if (!global.io) {
  // μ„λ²„κ°€ μ—†λ”λ° λΈλ΅λ“μΊμ¤νΈν•λ ¤κ³  ν•λ©΄?
  // β†’ μ—λ¬ λ°μƒ! π’¥
}
```

**ν™•μΈν•λ” μ΄μ :**
- β… μ„λ²„κ°€ μμΌλ©΄ β†’ λΈλ΅λ“μΊμ¤νΈ μ„±κ³µ
- β μ„λ²„κ°€ μ—†μΌλ©΄ β†’ λΈλ΅λ“μΊμ¤νΈ μ‹¤ν¨ (μ—λ¬)
- β οΈ μ„λ²„κ°€ μ—†μΌλ©΄ β†’ κ²½κ³  λ©”μ‹μ§€ μ¶λ ¥ν•κ³  μΆ…λ£

### 3. μ‹¤μ  μ½”λ“μ—μ„ μ–΄λ–»κ² ν™•μΈν•λ‚?

```javascript
// src/app/api/cti/incoming-call/route.ts

// 1λ‹¨κ³„: Socket.IO μ„λ²„κ°€ μλ”μ§€ ν™•μΈ
if (global.io) {
  // β… μ„λ²„κ°€ μμ!
  // β†’ λΈλ΅λ“μΊμ¤νΈ μ§„ν–‰
} else {
  // β μ„λ²„κ°€ μ—†μ!
  // β†’ κ²½κ³  λ©”μ‹μ§€ μ¶λ ¥ν•κ³  μΆ…λ£
  console.warn('β οΈ Socket.IO μ„λ²„κ°€ μ΄κΈ°ν™”λμ§€ μ•μ•μµλ‹λ‹¤');
}
```

**ν™•μΈ μμ„:**
1. `global.io`κ°€ μ΅΄μ¬ν•λ”κ°€? (`!!global.io`)
2. μ΅΄μ¬ν•λ©΄ β†’ λΈλ΅λ“μΊμ¤νΈ μ§„ν–‰
3. μ—†μΌλ©΄ β†’ κ²½κ³  μ¶λ ¥ν•κ³  μΆ…λ£

---

## π“Ά λΈλ΅λ“μΊμ¤νΈ (Broadcast)λ€?

### 1. λΈλ΅λ“μΊμ¤νΈ μ‰½κ² μ΄ν•΄ν•κΈ°

**μΌμƒ μƒν™ μμ‹:**
```
λ°©μ†΅κµ­ β†’ λΌλ””μ¤/TV λ°©μ†΅
  β†’ λ¨λ“  μ²­μ·¨μ/μ‹μ²­μμ—κ² λ™μ‹μ— μ „μ†΅ π“»

Socket.IO β†’ λΈλ΅λ“μΊμ¤νΈ
  β†’ λ¨λ“  μ—°κ²°λ ν΄λΌμ΄μ–ΈνΈμ—κ² λ™μ‹μ— μ „μ†΅ π’»
```

**λΉ„μ :**
- π“Ά μ¤ν”Όμ»¤λ΅ λ°©μ†΅ν•λ” κ²ƒκ³Ό κ°™μ
- μ—°κ²°λ λ¨λ“  ν΄λΌμ΄μ–ΈνΈκ°€ λ™μ‹μ— λ“£κ² λ¨
- 1λ…μ—κ²λ§ λ³΄λ‚΄λ” κ² μ•„λ‹λΌ λ¨λ‘μ—κ² λ³΄λƒ„

### 2. Socket.IO λΈλ΅λ“μΊμ¤νΈ λ™μ‘ λ°©μ‹

```
[μ„λ²„]                    [ν΄λΌμ΄μ–ΈνΈλ“¤]
  β”‚
  β”‚ io.emit('cti-event', λ°μ΄ν„°)
  β”‚
  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€> [λΈλΌμ°μ € 1] β…
  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€> [λΈλΌμ°μ € 2] β…
  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€> [λΈλΌμ°μ € 3] β…
  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€> [λΈλΌμ°μ € N] β…
  
λ¨λ“  μ—°κ²°λ ν΄λΌμ΄μ–ΈνΈμ—κ² λ™μ‹μ— μ „μ†΅!
```

**μ½”λ“λ΅ λ³΄λ©΄:**
```javascript
// Socket.IO μ„λ²„μ—μ„
global.io.emit('cti-event', ctiEvent);
//         β†‘      β†‘
//         μ΄λ²¤νΈλ…  λ°μ΄ν„°
```

**μλ―Έ:**
- `emit`: "μ „μ†΅ν•λ‹¤" (μ΄λ²¤νΈ λ°μƒ)
- `'cti-event'`: μ΄λ²¤νΈ μ΄λ¦„ (λ¦¬μ¤λ„κ°€ λ“£λ” μ΄λ¦„)
- `ctiEvent`: μ „μ†΅ν•  λ°μ΄ν„° (CID μ •λ³΄)

### 3. μ™ λΈλ΅λ“μΊμ¤νΈλ¥Ό μ‚¬μ©ν•λ‚?

**μΌλ°μ μΈ μ”μ²­-μ‘λ‹µ λ°©μ‹:**
```
ν΄λΌμ΄μ–ΈνΈ 1 β”€β”€> μ”μ²­ β”€β”€> μ„λ²„
ν΄λΌμ΄μ–ΈνΈ 2 β”€β”€> μ”μ²­ β”€β”€> μ„λ²„
ν΄λΌμ΄μ–ΈνΈ 3 β”€β”€> μ”μ²­ β”€β”€> μ„λ²„
...
```
- κ° ν΄λΌμ΄μ–ΈνΈκ°€ μ§μ ‘ μ”μ²­ν•΄μ•Ό ν•¨
- μƒλ΅κ³ μΉ¨ν•μ§€ μ•μΌλ©΄ μ—…λ°μ΄νΈ μ• λ¨

**λΈλ΅λ“μΊμ¤νΈ λ°©μ‹:**
```
μ„λ²„ β”€β”€> λΈλ΅λ“μΊμ¤νΈ β”€β”€> ν΄λΌμ΄μ–ΈνΈ 1, 2, 3... λ¨λ‘
```
- μ„λ²„κ°€ ν• λ²λ§ λ³΄λ‚΄λ©΄ λ¨λ“  ν΄λΌμ΄μ–ΈνΈκ°€ λ°›μ
- μ‹¤μ‹κ°„μΌλ΅ μ—…λ°μ΄νΈλ¨! β΅

**CTI CIDμ—μ„ λΈλ΅λ“μΊμ¤νΈλ¥Ό μ‚¬μ©ν•λ” μ΄μ :**
- μ „ν™”κ°€ μ¤λ©΄ μ—¬λ¬ λΈλΌμ°μ €μ—μ„ λ™μ‹μ— μ•λ¦Όμ΄ ν•„μ”
- μ‹¤μ‹κ°„μΌλ΅ λ¨λ“  μ‚¬μ©μμ—κ² CID μ •λ³΄ μ „λ‹¬
- μƒλ΅κ³ μΉ¨ μ—†μ΄ μλ™μΌλ΅ μ—…λ°μ΄νΈ

---

## π”„ μ „μ²΄ νλ¦„ (μ‰½κ² μ΄ν•΄ν•κΈ°)

### λ‹¨κ³„λ³„ μ„¤λ…

```
[1] CTI Bridgeμ—μ„ CID μμ‹ 
    β””β”€> "μ „ν™” μ™”μ–΄μ”!" μ •λ³΄λ¥Ό Next.js APIλ΅ λ³΄λƒ„

[2] Next.js APIμ—μ„ λ°›μ
    β””β”€> "μ•„, μ „ν™”κ°€ μ™”κµ¬λ‚!"
    β””β”€> Socket.IO μ„λ²„κ°€ μλ”μ§€ ν™•μΈ (`global.io` μ²΄ν¬)
    
[3] Socket.IO μ„λ²„ ν™•μΈ
    β”β”€> β… μμ: λΈλ΅λ“μΊμ¤νΈ μ§„ν–‰
    β””β”€> β μ—†μ: κ²½κ³  λ©”μ‹μ§€ μ¶λ ¥ν•κ³  μΆ…λ£
    
[4] λΈλ΅λ“μΊμ¤νΈ (μ„λ²„κ°€ μλ” κ²½μ°)
    β””β”€> global.io.emit('cti-event', ctiEvent)
    β””β”€> λ¨λ“  μ—°κ²°λ λΈλΌμ°μ €μ—κ² μ „μ†΅
    
[5] λΈλΌμ°μ €μ—μ„ λ°›μ
    β””β”€> Socket.IO ν΄λΌμ΄μ–ΈνΈκ°€ 'cti-event' μμ‹ 
    β””β”€> React μƒνƒ μ—…λ°μ΄νΈ
    β””β”€> CTI Panelμ— ν‘μ‹!
```

---

## π’΅ ν•µμ‹¬ μ •λ¦¬

### `global.io` μ²΄ν¬λ€?
- **λ©μ :** Socket.IO μ„λ²„κ°€ μ‹¤ν–‰ μ¤‘μΈμ§€ ν™•μΈ
- **λ°©λ²•:** `if (global.io)` μ΅°κ±΄λ¬ΈμΌλ΅ ν™•μΈ
- **κ²°κ³Ό:**
  - μμΌλ©΄ β†’ λΈλ΅λ“μΊμ¤νΈ μ§„ν–‰ β…
  - μ—†μΌλ©΄ β†’ κ²½κ³  μ¶λ ¥ν•κ³  μΆ…λ£ β

### λΈλ΅λ“μΊμ¤νΈλ€?
- **λ©μ :** λ¨λ“  μ—°κ²°λ ν΄λΌμ΄μ–ΈνΈμ—κ² λ™μ‹μ— λ°μ΄ν„° μ „μ†΅
- **λ°©λ²•:** `global.io.emit('cti-event', λ°μ΄ν„°)` μ‹¤ν–‰
- **κ²°κ³Ό:** λ¨λ“  λΈλΌμ°μ €κ°€ μ‹¤μ‹κ°„μΌλ΅ CID μ •λ³΄λ¥Ό λ°›μ β…

### μ™ λ‘ λ‹¤ ν•„μ”ν•κ°€?
1. **`global.io` μ²΄ν¬:** μ„λ²„κ°€ μ—†μΌλ©΄ λΈλ΅λ“μΊμ¤νΈ μμ²΄κ°€ λ¶κ°€λ¥ β†’ λ―Έλ¦¬ ν™•μΈ
2. **λΈλ΅λ“μΊμ¤νΈ:** μ„λ²„κ°€ μμΌλ©΄ λ¨λ“  ν΄λΌμ΄μ–ΈνΈμ—κ² μ „μ†΅ β†’ μ‹¤μ‹κ°„ μ—…λ°μ΄νΈ

---

## π― μ‹¤μ  μ½”λ“ μ„μΉ

### 1. Socket.IO μ„λ²„ μ΄κΈ°ν™” (μƒμμ— μ €μ¥)
**νμΌ:** `src/app/api/socket/route.ts`
```javascript
const io = new ServerIO(httpServer);
(global as any).io = io;  // β† μ—¬κΈ°μ„ "μƒμ"μ— μ €μ¥!
```

### 2. Socket.IO μ„λ²„ ν™•μΈ λ° λΈλ΅λ“μΊμ¤νΈ
**νμΌ:** `src/app/api/cti/incoming-call/route.ts`
```javascript
// Socket.IO μ„λ²„ ν™•μΈ
if (global.io) {  // β† "μƒμ"μ— λ­κ°€ μλ”μ§€ ν™•μΈ!
  // λΈλ΅λ“μΊμ¤νΈ μ§„ν–‰
  global.io.emit('cti-event', ctiEvent);  // β† λ¨λ“  ν΄λΌμ΄μ–ΈνΈμ—κ² μ „μ†΅!
}
```

---

## β“ μμ£Ό λ¬»λ” μ§λ¬Έ

### Q1: `global.io`κ°€ μ—†μΌλ©΄ μ–΄λ–»κ² λλ‚μ”?
**A:** λΈλ΅λ“μΊμ¤νΈλ¥Ό ν•  μ μ—†μ–΄μ„ κ²½κ³  λ©”μ‹μ§€λ§ μ¶λ ¥ν•κ³  μΆ…λ£λ©λ‹λ‹¤.
```
β οΈ Socket.IO μ„λ²„κ°€ μ΄κΈ°ν™”λμ§€ μ•μ•μµλ‹λ‹¤
```

### Q2: λΈλ΅λ“μΊμ¤νΈλ” λ„κµ¬μ—κ² μ „μ†΅λλ‚μ”?
**A:** Socket.IO μ„λ²„μ— μ—°κ²°λ λ¨λ“  ν΄λΌμ΄μ–ΈνΈμ—κ² μ „μ†΅λ©λ‹λ‹¤.
- λΈλΌμ°μ €κ°€ νμ΄μ§€λ¥Ό μ—΄κ³  Socket.IOμ— μ—°κ²°λμ–΄ μμ–΄μ•Ό λ°›μ„ μ μμµλ‹λ‹¤

### Q3: ν΄λΌμ΄μ–ΈνΈκ°€ μ—†μΌλ©΄ λΈλ΅λ“μΊμ¤νΈλ” μ‹¤ν¨ν•λ‚μ”?
**A:** μ•„λ‹μ”, λΈλ΅λ“μΊμ¤νΈ μμ²΄λ” μ„±κ³µν•μ§€λ§ λ°›μ„ ν΄λΌμ΄μ–ΈνΈκ°€ μ—†μ„ λΏμ…λ‹λ‹¤.
- μ„λ²„ λ΅κ·Έμ— "μ—°κ²°λ ν΄λΌμ΄μ–ΈνΈκ°€ μ—†μµλ‹λ‹¤" κ²½κ³ κ°€ μ¶λ ¥λ©λ‹λ‹¤

---

μ΄μ  μ΄ν•΄κ°€ λμ…¨λ‚μ”? λ” κ¶κΈν• λ¶€λ¶„μ΄ μμΌλ©΄ μ•λ ¤μ£Όμ„Έμ”! π




