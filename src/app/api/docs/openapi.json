{
  "openapi": "3.0.3",
  "info": {
    "title": "D-Care Console API",
    "description": "치과 아웃바운드 관리 시스템 API\n\n## 인증\n모든 V2 API는 JWT Bearer 토큰 인증이 필요합니다.\n`Authorization: Bearer <token>` 헤더를 포함하세요.",
    "version": "2.0.0"
  },
  "servers": [
    { "url": "/", "description": "현재 서버" }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {
      "Error": {
        "type": "object",
        "properties": {
          "success": { "type": "boolean", "example": false },
          "error": { "type": "string" }
        }
      },
      "Pagination": {
        "type": "object",
        "properties": {
          "page": { "type": "integer" },
          "limit": { "type": "integer" },
          "totalCount": { "type": "integer" },
          "totalPages": { "type": "integer" }
        }
      },
      "Patient": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "name": { "type": "string" },
          "phone": { "type": "string" },
          "status": { "type": "string", "enum": ["consulting", "reserved", "visited", "treatmentBooked", "treatment", "completed", "followup", "closed"] },
          "temperature": { "type": "string", "enum": ["hot", "warm", "cold"] },
          "interest": { "type": "string" },
          "source": { "type": "string" },
          "consultationType": { "type": "string" },
          "age": { "type": "integer" },
          "urgency": { "type": "string", "enum": ["noshow", "today", "overdue", "normal"] },
          "daysInStatus": { "type": "integer" },
          "nextAction": { "type": "string" },
          "nextActionDate": { "type": "string", "format": "date-time" },
          "createdAt": { "type": "string", "format": "date-time" },
          "lastContactAt": { "type": "string", "format": "date-time" }
        }
      },
      "CallLog": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "phone": { "type": "string" },
          "callType": { "type": "string", "enum": ["inbound", "outbound"] },
          "duration": { "type": "integer" },
          "callTime": { "type": "string", "format": "date-time" },
          "patientId": { "type": "string" },
          "patientName": { "type": "string" },
          "classification": { "type": "string", "enum": ["환자", "거래처", "스팸", "기타"] },
          "summary": { "type": "string" },
          "interest": { "type": "string" },
          "temperature": { "type": "string" },
          "status": { "type": "string", "enum": ["pending", "processing", "completed"] },
          "callbackType": { "type": "string", "enum": ["callback", "recall", "thanks"] }
        }
      },
      "Consultation": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "patientId": { "type": "string" },
          "patientName": { "type": "string" },
          "type": { "type": "string", "enum": ["phone", "visit"] },
          "status": { "type": "string", "enum": ["agreed", "disagreed", "pending"] },
          "treatment": { "type": "string" },
          "originalAmount": { "type": "number" },
          "discountRate": { "type": "number" },
          "finalAmount": { "type": "number" },
          "consultantName": { "type": "string" },
          "date": { "type": "string", "format": "date-time" },
          "createdAt": { "type": "string", "format": "date-time" }
        }
      },
      "Callback": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "patientId": { "type": "string" },
          "patientName": { "type": "string" },
          "patientPhone": { "type": "string" },
          "type": { "type": "string", "enum": ["callback", "recall", "thanks"] },
          "scheduledAt": { "type": "string", "format": "date-time" },
          "status": { "type": "string", "enum": ["pending", "completed", "missed"] },
          "note": { "type": "string" }
        }
      },
      "AuthUser": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "username": { "type": "string" },
          "email": { "type": "string" },
          "name": { "type": "string" },
          "role": { "type": "string", "enum": ["admin", "master", "manager", "staff"] },
          "clinicId": { "type": "string" }
        }
      }
    }
  },
  "security": [{ "bearerAuth": [] }],
  "paths": {
    "/api/auth/login": {
      "post": {
        "tags": ["Auth"],
        "summary": "로그인",
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["email", "password"],
                "properties": {
                  "email": { "type": "string", "description": "사용자명 또는 이메일" },
                  "password": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "로그인 성공",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" },
                    "token": { "type": "string", "description": "JWT Access Token (15분)" },
                    "refreshToken": { "type": "string", "description": "Refresh Token (7일)" },
                    "user": { "$ref": "#/components/schemas/AuthUser" }
                  }
                }
              }
            }
          },
          "401": { "description": "인증 실패", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      },
      "delete": {
        "tags": ["Auth"],
        "summary": "로그아웃 (Refresh Token 폐기)",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "refreshToken": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "로그아웃 성공",
            "content": { "application/json": { "schema": { "type": "object", "properties": { "success": { "type": "boolean" }, "message": { "type": "string" } } } } }
          }
        }
      }
    },
    "/api/auth/refresh": {
      "post": {
        "tags": ["Auth"],
        "summary": "토큰 갱신 (Token Rotation)",
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["refreshToken"],
                "properties": {
                  "refreshToken": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "갱신 성공 (이전 Refresh Token은 폐기됨)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" },
                    "token": { "type": "string" },
                    "refreshToken": { "type": "string" },
                    "user": { "$ref": "#/components/schemas/AuthUser" }
                  }
                }
              }
            }
          },
          "401": { "description": "유효하지 않거나 만료된 Refresh Token" }
        }
      }
    },
    "/api/v2/patients": {
      "get": {
        "tags": ["Patients"],
        "summary": "환자 목록 조회",
        "parameters": [
          { "name": "page", "in": "query", "schema": { "type": "integer", "default": 1 } },
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 20, "maximum": 50 } },
          { "name": "status", "in": "query", "schema": { "type": "string", "enum": ["consulting", "reserved", "visited", "treatmentBooked", "treatment", "completed", "followup", "closed"] } },
          { "name": "temperature", "in": "query", "schema": { "type": "string", "enum": ["hot", "warm", "cold"] } },
          { "name": "search", "in": "query", "schema": { "type": "string" }, "description": "이름 또는 전화번호 검색" },
          { "name": "urgency", "in": "query", "schema": { "type": "string", "enum": ["noshow", "today", "overdue", "normal"] } },
          { "name": "period", "in": "query", "schema": { "type": "string", "enum": ["1month", "3months", "6months", "1year", "all"], "default": "3months" } },
          { "name": "sortBy", "in": "query", "schema": { "type": "string", "default": "createdAt" } },
          { "name": "sortOrder", "in": "query", "schema": { "type": "string", "enum": ["asc", "desc"] } }
        ],
        "responses": {
          "200": {
            "description": "환자 목록",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "patients": { "type": "array", "items": { "$ref": "#/components/schemas/Patient" } },
                    "pagination": { "$ref": "#/components/schemas/Pagination" },
                    "filterStats": { "type": "object", "description": "상태별 환자 수" },
                    "urgentStats": { "type": "object", "properties": { "noshow": { "type": "integer" }, "today": { "type": "integer" }, "overdue": { "type": "integer" } } }
                  }
                }
              }
            }
          },
          "401": { "description": "인증 필요" }
        }
      },
      "post": {
        "tags": ["Patients"],
        "summary": "신규 환자 등록",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["name", "phone"],
                "properties": {
                  "name": { "type": "string" },
                  "phone": { "type": "string" },
                  "consultationType": { "type": "string" },
                  "interest": { "type": "string", "description": "관심 시술" },
                  "source": { "type": "string", "description": "유입 경로" },
                  "temperature": { "type": "string", "enum": ["hot", "warm", "cold"], "default": "warm" },
                  "age": { "type": "integer" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "등록 성공",
            "content": { "application/json": { "schema": { "type": "object", "properties": { "success": { "type": "boolean" }, "patientId": { "type": "string" } } } } }
          },
          "409": { "description": "전화번호 중복" }
        }
      }
    },
    "/api/v2/patients/{id}": {
      "get": {
        "tags": ["Patients"],
        "summary": "환자 상세 조회",
        "parameters": [{ "name": "id", "in": "path", "required": true, "schema": { "type": "string" } }],
        "responses": {
          "200": {
            "description": "환자 정보 + 최근 통화 10건",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "patient": { "$ref": "#/components/schemas/Patient" },
                    "callLogs": { "type": "array", "items": { "$ref": "#/components/schemas/CallLog" } }
                  }
                }
              }
            }
          },
          "404": { "description": "환자를 찾을 수 없음" }
        }
      },
      "patch": {
        "tags": ["Patients"],
        "summary": "환자 정보 수정",
        "parameters": [{ "name": "id", "in": "path", "required": true, "schema": { "type": "string" } }],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": { "type": "string" },
                  "phone": { "type": "string" },
                  "status": { "type": "string" },
                  "temperature": { "type": "string" },
                  "interest": { "type": "string" },
                  "nextAction": { "type": "string" },
                  "nextActionDate": { "type": "string", "format": "date-time" },
                  "memo": { "type": "string" },
                  "estimatedAmount": { "type": "number" },
                  "actualAmount": { "type": "number" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "수정 성공", "content": { "application/json": { "schema": { "type": "object", "properties": { "success": { "type": "boolean" } } } } } },
          "404": { "description": "환자를 찾을 수 없음" }
        }
      },
      "delete": {
        "tags": ["Patients"],
        "summary": "환자 삭제",
        "parameters": [{ "name": "id", "in": "path", "required": true, "schema": { "type": "string" } }],
        "responses": {
          "200": { "description": "삭제 성공" },
          "404": { "description": "환자를 찾을 수 없음" }
        }
      }
    },
    "/api/v2/call-logs": {
      "get": {
        "tags": ["Call Logs"],
        "summary": "통화 기록 목록 조회",
        "parameters": [
          { "name": "page", "in": "query", "schema": { "type": "integer", "default": 1 } },
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 20 } },
          { "name": "direction", "in": "query", "schema": { "type": "string", "enum": ["inbound", "outbound"] } },
          { "name": "classification", "in": "query", "schema": { "type": "string", "enum": ["환자", "거래처", "스팸", "기타"] } },
          { "name": "date", "in": "query", "schema": { "type": "string", "format": "date" }, "description": "YYYY-MM-DD" },
          { "name": "search", "in": "query", "schema": { "type": "string" }, "description": "전화번호 검색" },
          { "name": "sortBy", "in": "query", "schema": { "type": "string", "default": "startedAt" } },
          { "name": "sortOrder", "in": "query", "schema": { "type": "string", "enum": ["asc", "desc"] } }
        ],
        "responses": {
          "200": {
            "description": "통화 기록 목록 + 분류 통계",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "callLogs": { "type": "array", "items": { "$ref": "#/components/schemas/CallLog" } },
                    "pagination": { "$ref": "#/components/schemas/Pagination" },
                    "stats": { "type": "object", "description": "분류별 통화 건수" }
                  }
                }
              }
            }
          }
        }
      },
      "patch": {
        "tags": ["Call Logs"],
        "summary": "통화 기록 AI 분석 결과 수정 / 환자 연결",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["callLogId"],
                "properties": {
                  "callLogId": { "type": "string" },
                  "classification": { "type": "string", "enum": ["환자", "거래처", "스팸", "기타"] },
                  "patientId": { "type": "string", "nullable": true, "description": "환자 연결 (null이면 연결 해제)" },
                  "patientName": { "type": "string" },
                  "interest": { "type": "string" },
                  "temperature": { "type": "string" },
                  "summary": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "수정 성공", "content": { "application/json": { "schema": { "type": "object", "properties": { "success": { "type": "boolean" }, "callLog": { "$ref": "#/components/schemas/CallLog" } } } } } }
        }
      }
    },
    "/api/v2/call-logs/{id}": {
      "get": {
        "tags": ["Call Logs"],
        "summary": "통화 상세 조회 (AI 분석 포함)",
        "parameters": [{ "name": "id", "in": "path", "required": true, "schema": { "type": "string" } }],
        "responses": {
          "200": {
            "description": "통화 상세 + AI 분석 결과",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": { "type": "string" },
                    "phone": { "type": "string" },
                    "direction": { "type": "string" },
                    "duration": { "type": "integer" },
                    "aiAnalysis": {
                      "type": "object",
                      "nullable": true,
                      "properties": {
                        "classification": { "type": "string" },
                        "summary": { "type": "string" },
                        "transcript": { "type": "string" },
                        "confidence": { "type": "number" }
                      }
                    }
                  }
                }
              }
            }
          },
          "404": { "description": "통화 기록 없음" }
        }
      },
      "patch": {
        "tags": ["Call Logs"],
        "summary": "통화 메타데이터 수정 / AI 분석 트리거",
        "parameters": [{ "name": "id", "in": "path", "required": true, "schema": { "type": "string" } }],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "recordingUrl": { "type": "string" },
                  "duration": { "type": "integer" },
                  "status": { "type": "string" },
                  "triggerAnalysis": { "type": "boolean", "description": "true면 STT + AI 분석 실행" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "수정 성공" }
        }
      }
    },
    "/api/v2/consultations": {
      "get": {
        "tags": ["Consultations"],
        "summary": "상담 기록 목록 조회",
        "parameters": [
          { "name": "patientId", "in": "query", "schema": { "type": "string" } },
          { "name": "type", "in": "query", "schema": { "type": "string", "enum": ["phone", "visit"] } },
          { "name": "status", "in": "query", "schema": { "type": "string", "enum": ["agreed", "disagreed", "pending"] } },
          { "name": "date", "in": "query", "schema": { "type": "string", "format": "date" } },
          { "name": "page", "in": "query", "schema": { "type": "integer", "default": 1 } },
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 50 } }
        ],
        "responses": {
          "200": {
            "description": "상담 기록",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" },
                    "data": {
                      "type": "object",
                      "properties": {
                        "consultations": { "type": "array", "items": { "$ref": "#/components/schemas/Consultation" } },
                        "pagination": { "$ref": "#/components/schemas/Pagination" }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Consultations"],
        "summary": "상담 기록 생성",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["patientId", "type", "status"],
                "properties": {
                  "patientId": { "type": "string" },
                  "type": { "type": "string", "enum": ["phone", "visit"] },
                  "status": { "type": "string", "enum": ["agreed", "disagreed", "pending"] },
                  "treatment": { "type": "string" },
                  "originalAmount": { "type": "number" },
                  "discountRate": { "type": "number" },
                  "appointmentDate": { "type": "string", "format": "date-time" },
                  "consultantName": { "type": "string" },
                  "memo": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "생성 성공", "content": { "application/json": { "schema": { "type": "object", "properties": { "success": { "type": "boolean" }, "data": { "$ref": "#/components/schemas/Consultation" } } } } } }
        }
      },
      "patch": {
        "tags": ["Consultations"],
        "summary": "상담 기록 수정",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["id"],
                "properties": {
                  "id": { "type": "string" },
                  "status": { "type": "string" },
                  "treatment": { "type": "string" },
                  "originalAmount": { "type": "number" },
                  "memo": { "type": "string" },
                  "editedBy": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "수정 성공" }
        }
      },
      "delete": {
        "tags": ["Consultations"],
        "summary": "상담 기록 삭제",
        "parameters": [{ "name": "id", "in": "query", "required": true, "schema": { "type": "string" } }],
        "responses": {
          "200": { "description": "삭제 성공" },
          "404": { "description": "기록 없음" }
        }
      }
    },
    "/api/v2/callbacks": {
      "get": {
        "tags": ["Callbacks"],
        "summary": "콜백 목록 조회",
        "parameters": [
          { "name": "date", "in": "query", "schema": { "type": "string", "format": "date" } },
          { "name": "status", "in": "query", "schema": { "type": "string", "enum": ["pending", "completed", "missed"] } },
          { "name": "type", "in": "query", "schema": { "type": "string", "enum": ["callback", "recall", "thanks"] } },
          { "name": "page", "in": "query", "schema": { "type": "integer", "default": 1 } },
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 20 } }
        ],
        "responses": {
          "200": {
            "description": "콜백 목록 + 오늘 통계",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" },
                    "data": {
                      "type": "object",
                      "properties": {
                        "callbacks": { "type": "array", "items": { "$ref": "#/components/schemas/Callback" } },
                        "pagination": { "$ref": "#/components/schemas/Pagination" },
                        "todayStats": { "type": "object" }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Callbacks"],
        "summary": "콜백 생성",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["patientId", "type", "scheduledAt"],
                "properties": {
                  "patientId": { "type": "string" },
                  "type": { "type": "string", "enum": ["callback", "recall", "thanks"] },
                  "scheduledAt": { "type": "string", "format": "date-time" },
                  "note": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "생성 성공" }
        }
      },
      "patch": {
        "tags": ["Callbacks"],
        "summary": "콜백 상태 변경",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["id", "status"],
                "properties": {
                  "id": { "type": "string" },
                  "status": { "type": "string", "enum": ["pending", "completed", "missed"] },
                  "note": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "변경 성공" }
        }
      },
      "delete": {
        "tags": ["Callbacks"],
        "summary": "콜백 삭제",
        "parameters": [{ "name": "id", "in": "query", "required": true, "schema": { "type": "string" } }],
        "responses": {
          "200": { "description": "삭제 성공" }
        }
      }
    },
    "/api/v2/dashboard": {
      "get": {
        "tags": ["Dashboard"],
        "summary": "대시보드 종합 지표",
        "responses": {
          "200": {
            "description": "오늘 통화 현황, 알림, 콜백, 환자 통계, 매출",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" },
                    "data": {
                      "type": "object",
                      "properties": {
                        "today": {
                          "type": "object",
                          "properties": {
                            "totalCalls": { "type": "integer" },
                            "analyzed": { "type": "integer" },
                            "newPatients": { "type": "integer" },
                            "missed": { "type": "integer" }
                          }
                        },
                        "alerts": { "type": "array", "description": "주의가 필요한 환자 그룹" },
                        "callbacks": { "type": "array", "description": "오늘 콜백 목록" },
                        "patientCounts": { "type": "object", "description": "상태별 환자 수" },
                        "todayTasks": { "type": "object", "description": "오늘/연체/내일 업무" },
                        "revenue": { "type": "object", "description": "이번 달/지난 달 매출" }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/v2/settings": {
      "get": {
        "tags": ["Settings"],
        "summary": "병원 설정 조회",
        "responses": {
          "200": {
            "description": "설정 정보",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" },
                    "data": {
                      "type": "object",
                      "properties": {
                        "clinicId": { "type": "string" },
                        "clinicName": { "type": "string" },
                        "cti": { "type": "object" },
                        "ai": { "type": "object" },
                        "notifications": { "type": "object" },
                        "targets": { "type": "object" }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      "patch": {
        "tags": ["Settings"],
        "summary": "병원 설정 수정",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "clinicName": { "type": "string" },
                  "cti": { "type": "object" },
                  "ai": { "type": "object" },
                  "notifications": { "type": "object" },
                  "targets": { "type": "object" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "수정 성공" }
        }
      }
    }
  },
  "tags": [
    { "name": "Auth", "description": "인증 (로그인/로그아웃/토큰 갱신)" },
    { "name": "Patients", "description": "환자 관리" },
    { "name": "Call Logs", "description": "통화 기록 + AI 분석" },
    { "name": "Consultations", "description": "상담 기록" },
    { "name": "Callbacks", "description": "콜백/리콜/감사 전화" },
    { "name": "Dashboard", "description": "대시보드 종합 지표" },
    { "name": "Settings", "description": "병원 설정" }
  ]
}
