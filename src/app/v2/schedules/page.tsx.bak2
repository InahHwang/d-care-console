// src/app/v2/schedules/page.tsx
'use client';

import React, { useState, useEffect, useCallback, Suspense } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import { PageHeader } from '@/components/v2/layout/PageHeader';
import {
  Phone,
  Calendar,
  Clock,
  CheckCircle,
  XCircle,
  AlertCircle,
  Plus,
  Filter,
  ChevronLeft,
  ChevronRight,
  Settings,
  History,
  PhoneMissed,
  Send,
  RefreshCw,
  Gift,
  Heart,
  MessageSquare,
  MoreVertical,
  Edit2,
  Trash2,
  Search,
  X,
  Check,
} from 'lucide-react';
import { TemperatureIcon } from '@/components/v2/common/TemperatureIcon';
import type { Temperature, CallbackType, CallbackStatus } from '@/types/v2';

// ============= Types =============
interface CallbackItem {
  id: string;
  patientId: string;
  patientName: string;
  patientPhone: string;
  patientInterest: string;
  patientTemperature: Temperature;
  patientStatus: string;
  type: CallbackType;
  scheduledAt: string;
  status: CallbackStatus;
  note?: string;
  completedAt?: string;
}

interface TodayStats {
  total: number;
  pending: number;
  completed: number;
  missed: number;
  callback: number;
  recall: number;
  thanks: number;
}

interface RecallSchedule {
  id: string;
  timing: string;
  timingDays: number;
  message: string;
  enabled: boolean;
}

interface RecallSetting {
  id: string;
  treatment: string;
  schedules: RecallSchedule[];
}

interface RecallMessage {
  id: string;
  patientId: string;
  patientName: string;
  patientPhone: string;
  treatment: string;
  timing: string;
  status: string;
  scheduledAt: string;
  sentAt?: string;
  bookedAt?: string;
  lastVisit: string;
  daysPassed?: number;
}

interface ThanksItem {
  id: string;
  referrerId: string;
  referrerName: string;
  referrerPhone: string;
  referredId: string;
  referredName: string;
  referredPhone: string;
  status: string;
  note?: string;
  referredAt: string;
  completedAt?: string;
}

// ============= Constants =============
type RecallSubTab = 'pending' | 'history' | 'call-needed';

const TIMING_OPTIONS = [
  { label: '1ì£¼ í›„', days: 7 },
  { label: '2ì£¼ í›„', days: 14 },
  { label: '1ê°œì›” í›„', days: 30 },
  { label: '3ê°œì›” í›„', days: 90 },
  { label: '6ê°œì›” í›„', days: 180 },
  { label: '1ë…„ í›„', days: 365 },
];

// ============= Main Component =============
function SchedulesContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const tabParam = searchParams.get('tab') as 'callback' | 'recall' | 'thanks' | null;

  // Main state
  const [activeTab, setActiveTab] = useState<'callback' | 'recall' | 'thanks'>(tabParam || 'callback');
  const [selectedDate, setSelectedDate] = useState<string>(new Date().toISOString().split('T')[0]);
  const [statusFilter, setStatusFilter] = useState<CallbackStatus | 'all'>('all');
  const [searchQuery, setSearchQuery] = useState('');

  // Callback state
  const [callbacks, setCallbacks] = useState<CallbackItem[]>([]);
  const [todayStats, setTodayStats] = useState<TodayStats | null>(null);
  const [loading, setLoading] = useState(true);
  const [showAddModal, setShowAddModal] = useState(false);

  // Recall state
  const [recallSubTab, setRecallSubTab] = useState<RecallSubTab>('pending');
  const [recallSettings, setRecallSettings] = useState<RecallSetting[]>([]);
  const [recallMessages, setRecallMessages] = useState<RecallMessage[]>([]);
  const [recallStats, setRecallStats] = useState({ pending: 0, sent: 0, booked: 0, noResponse: 0, callNeeded: 0 });
  const [showAddTreatmentModal, setShowAddTreatmentModal] = useState(false);
  const [editingSchedule, setEditingSchedule] = useState<{ settingId: string; schedule?: RecallSchedule } | null>(null);

  // Thanks state
  const [thanks, setThanks] = useState<ThanksItem[]>([]);
  const [thanksStats, setThanksStats] = useState({ pending: 0, completed: 0, total: 0 });

  // ============= Callbacks API =============
  const fetchCallbacks = useCallback(async () => {
    try {
      setLoading(true);
      const params = new URLSearchParams();
      params.set('date', selectedDate);
      if (statusFilter !== 'all') params.set('status', statusFilter);

      const response = await fetch(`/api/v2/callbacks?${params}`);
      const result = await response.json();

      if (result.success) {
        let filtered = result.data.callbacks.filter((c: CallbackItem) => c.type === 'callback');
        if (searchQuery) {
          const q = searchQuery.toLowerCase();
          filtered = filtered.filter((c: CallbackItem) =>
            c.patientName.toLowerCase().includes(q) || c.patientPhone.includes(searchQuery)
          );
        }
        setCallbacks(filtered);
        setTodayStats(result.data.todayStats);
      }
    } catch (error) {
      console.error('Failed to fetch callbacks:', error);
    } finally {
      setLoading(false);
    }
  }, [selectedDate, statusFilter, searchQuery]);

  // ============= Recall Settings API =============
  const fetchRecallSettings = useCallback(async () => {
    try {
      const response = await fetch('/api/v2/recall-settings');
      const result = await response.json();
      if (result.success) {
        setRecallSettings(result.data);
      }
    } catch (error) {
      console.error('Failed to fetch recall settings:', error);
    }
  }, []);

  // ============= Recall Messages API =============
  const fetchRecallMessages = useCallback(async (status?: string) => {
    try {
      const params = new URLSearchParams();
      if (status) params.set('status', status);

      const response = await fetch(`/api/v2/recall-messages?${params}`);
      const result = await response.json();

      if (result.success) {
        setRecallMessages(result.data.messages);
        setRecallStats(result.data.stats);
      }
    } catch (error) {
      console.error('Failed to fetch recall messages:', error);
    }
  }, []);

  // ============= Thanks API =============
  const fetchThanks = useCallback(async () => {
    try {
      const params = new URLSearchParams();
      if (statusFilter !== 'all') params.set('status', statusFilter);
      if (searchQuery) params.set('search', searchQuery);

      const response = await fetch(`/api/v2/thanks?${params}`);
      const result = await response.json();

      if (result.success) {
        setThanks(result.data.thanks);
        setThanksStats(result.data.stats);
      }
    } catch (error) {
      console.error('Failed to fetch thanks:', error);
    }
  }, [statusFilter, searchQuery]);

  // ============= Effects =============
  useEffect(() => {
    if (activeTab === 'callback') {
      fetchCallbacks();
    } else if (activeTab === 'recall') {
      if (recallSubTab === 'pending') {
        fetchRecallMessages('pending');
      } else if (recallSubTab === 'history') {
        fetchRecallMessages();
      } else if (recallSubTab === 'call-needed') {
        fetchRecallMessages('call-needed');
      }
    } else if (activeTab === 'thanks') {
      fetchThanks();
    }
  }, [activeTab, recallSubTab, fetchCallbacks, fetchRecallMessages, fetchThanks]);

  // ============= Handlers =============
  const handleDateChange = (days: number) => {
    const date = new Date(selectedDate);
    date.setDate(date.getDate() + days);
    setSelectedDate(date.toISOString().split('T')[0]);
  };

  const handleCall = (phone: string) => {
    window.dispatchEvent(new CustomEvent('cti-call', { detail: { phone } }));
  };

  const handleCallbackStatusChange = async (id: string, status: CallbackStatus) => {
    try {
      const response = await fetch('/api/v2/callbacks', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, status }),
      });
      if (response.ok) {
        fetchCallbacks();
      }
    } catch (error) {
      console.error('Failed to update status:', error);
    }
  };

  const handleRecallSend = async (id: string) => {
    try {
      const response = await fetch(`/api/v2/recall-messages/${id}/send`, {
        method: 'POST',
      });
      if (response.ok) {
        fetchRecallMessages('pending');
        alert('ì•Œë¦¼í†¡ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤ (Mock)');
      }
    } catch (error) {
      console.error('Failed to send:', error);
    }
  };

  const handleRecallCancel = async (id: string) => {
    if (!confirm('ë°œì†¡ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
      const response = await fetch(`/api/v2/recall-messages/${id}/cancel`, {
        method: 'POST',
      });
      if (response.ok) {
        fetchRecallMessages('pending');
      }
    } catch (error) {
      console.error('Failed to cancel:', error);
    }
  };

  const handleRecallComplete = async (id: string) => {
    try {
      const response = await fetch(`/api/v2/recall-messages/${id}/complete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ result: 'contacted' }),
      });
      if (response.ok) {
        fetchRecallMessages('call-needed');
      }
    } catch (error) {
      console.error('Failed to complete:', error);
    }
  };

  const handleThanksComplete = async (id: string, method: 'call' | 'message') => {
    try {
      const response = await fetch('/api/v2/thanks', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, status: 'completed', method }),
      });
      if (response.ok) {
        fetchThanks();
      }
    } catch (error) {
      console.error('Failed to complete thanks:', error);
    }
  };

  const handleAddTreatment = async (treatment: string) => {
    try {
      const response = await fetch('/api/v2/recall-settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ treatment, schedules: [] }),
      });
      if (response.ok) {
        setShowAddTreatmentModal(false);
        fetchRecallSettings();
      }
    } catch (error) {
      console.error('Failed to add treatment:', error);
    }
  };

  const handleDeleteTreatment = async (id: string) => {
    if (!confirm('ì´ ì¹˜ë£Œ ì„¤ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
      const response = await fetch(`/api/v2/recall-settings?id=${id}`, {
        method: 'DELETE',
      });
      if (response.ok) {
        fetchRecallSettings();
      }
    } catch (error) {
      console.error('Failed to delete treatment:', error);
    }
  };

  const handleSaveSchedule = async (settingId: string, schedule: RecallSchedule, isNew: boolean) => {
    try {
      const setting = recallSettings.find(s => s.id === settingId);
      if (!setting) return;

      let newSchedules: RecallSchedule[];
      if (isNew) {
        newSchedules = [...setting.schedules, { ...schedule, id: Date.now().toString() }];
      } else {
        newSchedules = setting.schedules.map(s => s.id === schedule.id ? schedule : s);
      }

      const response = await fetch('/api/v2/recall-settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: settingId, schedules: newSchedules }),
      });

      if (response.ok) {
        setEditingSchedule(null);
        fetchRecallSettings();
      }
    } catch (error) {
      console.error('Failed to save schedule:', error);
    }
  };

  const handleDeleteSchedule = async (settingId: string, scheduleId: string) => {
    try {
      const setting = recallSettings.find(s => s.id === settingId);
      if (!setting) return;

      const newSchedules = setting.schedules.filter(s => s.id !== scheduleId);

      const response = await fetch('/api/v2/recall-settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: settingId, schedules: newSchedules }),
      });

      if (response.ok) {
        fetchRecallSettings();
      }
    } catch (error) {
      console.error('Failed to delete schedule:', error);
    }
  };

  const handleToggleSchedule = async (settingId: string, scheduleId: string, enabled: boolean) => {
    try {
      const setting = recallSettings.find(s => s.id === settingId);
      if (!setting) return;

      const newSchedules = setting.schedules.map(s =>
        s.id === scheduleId ? { ...s, enabled } : s
      );

      const response = await fetch('/api/v2/recall-settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: settingId, schedules: newSchedules }),
      });

      if (response.ok) {
        fetchRecallSettings();
      }
    } catch (error) {
      console.error('Failed to toggle schedule:', error);
    }
  };

  const handlePatientClick = (patientId: string) => {
    router.push(`/v2/patients/${patientId}`);
  };

  const formatTime = (dateStr: string) => {
    const date = new Date(dateStr);
    return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
  };

  const formatDate = (dateStr: string) => {
    const date = new Date(dateStr);
    return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
  };

  const formatDateLabel = (dateStr: string) => {
    const date = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const targetDate = new Date(dateStr);
    targetDate.setHours(0, 0, 0, 0);
    const diff = Math.floor((targetDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));

    if (diff === 0) return 'ì˜¤ëŠ˜';
    if (diff === 1) return 'ë‚´ì¼';
    if (diff === -1) return 'ì–´ì œ';
    return date.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' });
  };

  const getTemperatureIcon = (temp: Temperature) => {
    switch (temp) {
      case 'hot': return <span className="text-lg">ğŸ”¥</span>;
      case 'warm': return <span className="text-lg">ğŸŒ¡ï¸</span>;
      case 'cold': return <span className="text-lg">â„ï¸</span>;
      default: return null;
    }
  };

  const tabs = [
    { id: 'callback' as const, label: 'ì½œë°±', icon: <Phone size={18} />, count: todayStats?.callback ?? 0 },
    { id: 'recall' as const, label: 'ë¦¬ì½œ', icon: <RefreshCw size={18} />, count: recallStats.pending + recallStats.callNeeded },
    { id: 'thanks' as const, label: 'ê°ì‚¬ì¸ì‚¬', icon: <Gift size={18} />, count: thanksStats.pending },
  ];

  const recallSubTabs = [
    { id: 'pending' as const, label: 'ë°œì†¡ ëŒ€ê¸°', icon: <Clock size={16} />, count: recallStats.pending },
    { id: 'history' as const, label: 'ë°œì†¡ ì´ë ¥', icon: <History size={16} /> },
    { id: 'call-needed' as const, label: 'ì „í™” í•„ìš”', icon: <PhoneMissed size={16} />, count: recallStats.callNeeded },
  ];

  // ============= Render =============
  return (
    <div className="p-6 space-y-6">
      <PageHeader
        title="ì¼ì • ê´€ë¦¬"
        subtitle="ì½œë°±, ë¦¬ì½œ, ê°ì‚¬ì „í™” ì¼ì •ì„ ê´€ë¦¬í•˜ì„¸ìš”"
        action={{
          label: 'ì¼ì • ì¶”ê°€',
          icon: <Plus className="w-4 h-4" />,
          onClick: () => setShowAddModal(true),
        }}
      />

      {/* ìš”ì•½ ì¹´ë“œ */}
      <div className="grid grid-cols-3 gap-4">
        <div className="bg-white rounded-xl p-4 border border-gray-100">
          <div className="flex items-center gap-3 mb-3">
            <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
              <Phone size={20} className="text-blue-600" />
            </div>
            <div>
              <div className="text-sm text-gray-500">ì˜¤ëŠ˜ ì½œë°±</div>
              <div className="text-xl font-bold text-gray-900">{todayStats?.callback ?? 0}ê±´</div>
            </div>
          </div>
          <div className="flex gap-3 text-xs">
            <span className="text-amber-600">ëŒ€ê¸° {todayStats?.pending ?? 0}</span>
            <span className="text-emerald-600">ì™„ë£Œ {todayStats?.completed ?? 0}</span>
            <span className="text-red-600">ë¯¸ì—°ê²° {todayStats?.missed ?? 0}</span>
          </div>
        </div>

        <div className="bg-white rounded-xl p-4 border border-gray-100">
          <div className="flex items-center gap-3 mb-3">
            <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
              <RefreshCw size={20} className="text-purple-600" />
            </div>
            <div>
              <div className="text-sm text-gray-500">ì˜¤ëŠ˜ ë¦¬ì½œ</div>
              <div className="text-xl font-bold text-gray-900">{recallStats.pending + recallStats.callNeeded}ê±´</div>
            </div>
          </div>
          <div className="flex gap-3 text-xs">
            <span className="text-amber-600">ë°œì†¡ëŒ€ê¸° {recallStats.pending}</span>
            <span className="text-red-600">ì „í™”í•„ìš” {recallStats.callNeeded}</span>
          </div>
        </div>

        <div className="bg-white rounded-xl p-4 border border-gray-100">
          <div className="flex items-center gap-3 mb-3">
            <div className="w-10 h-10 bg-rose-100 rounded-lg flex items-center justify-center">
              <Gift size={20} className="text-rose-600" />
            </div>
            <div>
              <div className="text-sm text-gray-500">ê°ì‚¬ì¸ì‚¬</div>
              <div className="text-xl font-bold text-gray-900">{thanksStats.total}ê±´</div>
            </div>
          </div>
          <div className="flex gap-3 text-xs">
            <span className="text-amber-600">ëŒ€ê¸° {thanksStats.pending}</span>
            <span className="text-emerald-600">ì™„ë£Œ {thanksStats.completed}</span>
          </div>
        </div>
      </div>

      {/* ë©”ì¸ íƒ­ */}
      <div className="bg-white rounded-xl border border-gray-100">
        <div className="flex border-b">
          {tabs.map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex items-center gap-2 px-6 py-4 font-medium transition-colors relative ${
                activeTab === tab.id ? 'text-blue-600' : 'text-gray-500 hover:text-gray-700'
              }`}
            >
              {tab.icon}
              {tab.label}
              <span className={`px-2 py-0.5 rounded-full text-xs ${
                activeTab === tab.id ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-600'
              }`}>
                {tab.count}
              </span>
              {activeTab === tab.id && (
                <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-blue-600" />
              )}
            </button>
          ))}
        </div>

        {/* ì½œë°± íƒ­ */}
        {activeTab === 'callback' && (
          <CallbackTab
            callbacks={callbacks}
            loading={loading}
            selectedDate={selectedDate}
            statusFilter={statusFilter}
            searchQuery={searchQuery}
            onDateChange={handleDateChange}
            onStatusFilterChange={setStatusFilter}
            onSearchChange={setSearchQuery}
            onCall={handleCall}
            onStatusChange={handleCallbackStatusChange}
            onPatientClick={handlePatientClick}
            formatTime={formatTime}
            formatDateLabel={formatDateLabel}
            getTemperatureIcon={getTemperatureIcon}
          />
        )}

        {/* ë¦¬ì½œ íƒ­ */}
        {activeTab === 'recall' && (
          <RecallTab
            subTab={recallSubTab}
            subTabs={recallSubTabs}
            settings={recallSettings}
            messages={recallMessages}
            onSubTabChange={setRecallSubTab}
            onSend={handleRecallSend}
            onCancel={handleRecallCancel}
            onComplete={handleRecallComplete}
            onCall={handleCall}
            onAddTreatment={() => setShowAddTreatmentModal(true)}
            onDeleteTreatment={handleDeleteTreatment}
            onEditSchedule={(settingId, schedule) => setEditingSchedule({ settingId, schedule })}
            onAddSchedule={(settingId) => setEditingSchedule({ settingId })}
            onDeleteSchedule={handleDeleteSchedule}
            onToggleSchedule={handleToggleSchedule}
            formatDate={formatDate}
          />
        )}

        {/* ê°ì‚¬ì¸ì‚¬ íƒ­ */}
        {activeTab === 'thanks' && (
          <ThanksTab
            thanks={thanks}
            statusFilter={statusFilter}
            searchQuery={searchQuery}
            onStatusFilterChange={setStatusFilter}
            onSearchChange={setSearchQuery}
            onCall={handleCall}
            onComplete={handleThanksComplete}
          />
        )}
      </div>

      {/* ì´ë²ˆ ì£¼ ìš”ì•½ */}
      <WeeklySummary />

      {/* ëª¨ë‹¬ë“¤ */}
      {showAddModal && (
        <AddCallbackModal
          onClose={() => setShowAddModal(false)}
          onSuccess={() => {
            setShowAddModal(false);
            fetchCallbacks();
          }}
        />
      )}

      {showAddTreatmentModal && (
        <AddTreatmentModal
          onClose={() => setShowAddTreatmentModal(false)}
          onAdd={handleAddTreatment}
        />
      )}

      {editingSchedule && (
        <EditScheduleModal
          settingId={editingSchedule.settingId}
          schedule={editingSchedule.schedule}
          onClose={() => setEditingSchedule(null)}
          onSave={handleSaveSchedule}
        />
      )}
    </div>
  );
}

// ============= Sub Components =============

// ì½œë°± íƒ­ ì»´í¬ë„ŒíŠ¸
function CallbackTab({
  callbacks,
  loading,
  selectedDate,
  statusFilter,
  searchQuery,
  onDateChange,
  onStatusFilterChange,
  onSearchChange,
  onCall,
  onStatusChange,
  onPatientClick,
  formatTime,
  formatDateLabel,
  getTemperatureIcon,
}: {
  callbacks: CallbackItem[];
  loading: boolean;
  selectedDate: string;
  statusFilter: string;
  searchQuery: string;
  onDateChange: (days: number) => void;
  onStatusFilterChange: (status: CallbackStatus | 'all') => void;
  onSearchChange: (query: string) => void;
  onCall: (phone: string) => void;
  onStatusChange: (id: string, status: CallbackStatus) => void;
  onPatientClick: (id: string) => void;
  formatTime: (date: string) => string;
  formatDateLabel: (date: string) => string;
  getTemperatureIcon: (temp: Temperature) => React.ReactNode;
}) {
  return (
    <>
      {/* í•„í„° */}
      <div className="p-4 border-b flex items-center justify-between">
        <div className="flex items-center gap-2">
          {(['all', 'pending', 'completed', 'missed'] as const).map(status => (
            <button
              key={status}
              onClick={() => onStatusFilterChange(status)}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                statusFilter === status
                  ? status === 'pending' ? 'bg-amber-500 text-white'
                    : status === 'completed' ? 'bg-emerald-500 text-white'
                    : status === 'missed' ? 'bg-red-500 text-white'
                    : 'bg-gray-900 text-white'
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              {status === 'all' ? 'ì „ì²´' : status === 'pending' ? 'ëŒ€ê¸°' : status === 'completed' ? 'ì™„ë£Œ' : 'ë¯¸ì—°ê²°'}
            </button>
          ))}
        </div>

        <div className="flex items-center gap-3">
          <div className="flex items-center gap-2 bg-gray-100 rounded-lg px-3 py-1.5">
            <button onClick={() => onDateChange(-1)} className="p-1 hover:bg-gray-200 rounded">
              <ChevronLeft size={16} />
            </button>
            <span className="text-sm font-medium min-w-[100px] text-center">{formatDateLabel(selectedDate)}</span>
            <button onClick={() => onDateChange(1)} className="p-1 hover:bg-gray-200 rounded">
              <ChevronRight size={16} />
            </button>
          </div>

          <div className="relative">
            <Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => onSearchChange(e.target.value)}
              placeholder="í™˜ìëª…, ì „í™”ë²ˆí˜¸ ê²€ìƒ‰"
              className="pl-10 pr-4 py-2 border rounded-lg text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
        </div>
      </div>

      {/* ëª©ë¡ */}
      <div className="divide-y">
        {loading ? (
          <div className="p-8 text-center text-gray-500">ë¡œë”© ì¤‘...</div>
        ) : callbacks.length === 0 ? (
          <div className="p-8 text-center">
            <Calendar className="w-12 h-12 text-gray-300 mx-auto mb-3" />
            <p className="text-gray-500">ë“±ë¡ëœ ì½œë°±ì´ ì—†ìŠµë‹ˆë‹¤</p>
          </div>
        ) : (
          callbacks.map(callback => (
            <div
              key={callback.id}
              className={`p-4 hover:bg-gray-50 transition-colors ${
                callback.status === 'completed' ? 'bg-gray-50 opacity-60' : ''
              }`}
            >
              <div className="flex items-start justify-between">
                <div className="flex items-start gap-4">
                  <div className="text-center min-w-[60px]">
                    <div className="text-lg font-bold text-gray-900">{formatTime(callback.scheduledAt)}</div>
                    <div className="text-xs text-gray-500">{callback.scheduledAt.split('T')[0].slice(5)}</div>
                  </div>

                  <div className="w-px h-16 bg-gray-200" />

                  <div className="flex-1 cursor-pointer" onClick={() => onPatientClick(callback.patientId)}>
                    <div className="flex items-center gap-2 mb-1">
                      <span className="font-bold text-gray-900">{callback.patientName}</span>
                      {getTemperatureIcon(callback.patientTemperature)}
                      <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                        callback.status === 'pending' ? 'bg-amber-100 text-amber-700'
                          : callback.status === 'completed' ? 'bg-emerald-100 text-emerald-700'
                          : 'bg-red-100 text-red-700'
                      }`}>
                        {callback.status === 'pending' ? 'ëŒ€ê¸°' : callback.status === 'completed' ? 'ì™„ë£Œ' : 'ë¯¸ì—°ê²°'}
                      </span>
                    </div>
                    <div className="text-sm text-gray-500 mb-2">{callback.patientPhone}</div>
                    <div className="flex items-center gap-2">
                      <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">
                        {callback.patientInterest}
                      </span>
                    </div>
                    {callback.note && (
                      <div className="text-sm text-gray-500 mt-2 flex items-center gap-1">
                        <MessageSquare size={14} />
                        {callback.note}
                      </div>
                    )}
                  </div>
                </div>

                <div className="flex items-center gap-2">
                  {callback.status === 'pending' && (
                    <>
                      <button
                        onClick={() => onCall(callback.patientPhone)}
                        className="flex items-center gap-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700"
                      >
                        <Phone size={16} />
                        ì „í™”
                      </button>
                      <button
                        onClick={() => onStatusChange(callback.id, 'completed')}
                        className="flex items-center gap-1 px-3 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700"
                      >
                        <Check size={16} />
                        ì™„ë£Œ
                      </button>
                    </>
                  )}
                  {callback.status === 'missed' && (
                    <button
                      onClick={() => onStatusChange(callback.id, 'pending')}
                      className="flex items-center gap-1 px-3 py-2 bg-amber-500 text-white rounded-lg text-sm font-medium hover:bg-amber-600"
                    >
                      <RefreshCw size={16} />
                      ì¬ì‹œë„
                    </button>
                  )}
                  {callback.status === 'completed' && callback.completedAt && (
                    <span className="text-sm text-gray-500">{callback.completedAt.slice(0, 16).replace('T', ' ')} ì™„ë£Œ</span>
                  )}
                </div>
              </div>
            </div>
          ))
        )}
      </div>
    </>
  );
}

// ë¦¬ì½œ íƒ­ ì»´í¬ë„ŒíŠ¸
function RecallTab({
  subTab,
  subTabs,
  settings,
  messages,
  onSubTabChange,
  onSend,
  onCancel,
  onComplete,
  onCall,
  onAddTreatment,
  onDeleteTreatment,
  onEditSchedule,
  onAddSchedule,
  onDeleteSchedule,
  onToggleSchedule,
  formatDate,
}: {
  subTab: RecallSubTab;
  subTabs: { id: RecallSubTab; label: string; icon: React.ReactNode; count?: number }[];
  settings: RecallSetting[];
  messages: RecallMessage[];
  onSubTabChange: (tab: RecallSubTab) => void;
  onSend: (id: string) => void;
  onCancel: (id: string) => void;
  onComplete: (id: string) => void;
  onCall: (phone: string) => void;
  onAddTreatment: () => void;
  onDeleteTreatment: (id: string) => void;
  onEditSchedule: (settingId: string, schedule: RecallSchedule) => void;
  onAddSchedule: (settingId: string) => void;
  onDeleteSchedule: (settingId: string, scheduleId: string) => void;
  onToggleSchedule: (settingId: string, scheduleId: string, enabled: boolean) => void;
  formatDate: (date: string) => string;
}) {
  return (
    <>
      {/* ì„œë¸Œíƒ­ */}
      <div className="p-4 border-b flex items-center gap-2">
        {subTabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => onSubTabChange(tab.id)}
            className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
              subTab === tab.id
                ? 'bg-purple-100 text-purple-700'
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }`}
          >
            {tab.icon}
            {tab.label}
            {tab.count !== undefined && (
              <span className={`px-1.5 py-0.5 rounded-full text-xs ${
                subTab === tab.id ? 'bg-purple-200 text-purple-700' : 'bg-gray-200 text-gray-600'
              }`}>
                {tab.count}
              </span>
            )}
          </button>
        ))}
      </div>

      {/* ë°œì†¡ ëŒ€ê¸° */}
      {subTab === 'pending' && (
        <div className="divide-y">
          {messages.filter(m => m.status === 'pending').length === 0 ? (
            <div className="p-8 text-center text-gray-500">ë°œì†¡ ëŒ€ê¸° ì¤‘ì¸ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>
          ) : (
            <>
              <div className="p-4 bg-amber-50 flex items-center gap-3">
                <Clock size={18} className="text-amber-600" />
                <span className="text-sm text-amber-700">
                  ì˜¤ëŠ˜ ë°œì†¡ ì˜ˆì • <strong>{messages.filter(m => m.status === 'pending').length}ê±´</strong>
                </span>
              </div>
              {messages.filter(m => m.status === 'pending').map(msg => (
                <div key={msg.id} className="p-4 hover:bg-gray-50">
                  <div className="flex items-start justify-between">
                    <div className="flex items-start gap-4">
                      <div className="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                        <Send size={18} className="text-purple-600" />
                      </div>
                      <div>
                        <div className="flex items-center gap-2 mb-1">
                          <span className="font-bold text-gray-900">{msg.patientName}</span>
                          <span className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">
                            {msg.treatment} {msg.timing}
                          </span>
                        </div>
                        <div className="text-sm text-gray-500 mb-1">{msg.patientPhone}</div>
                        <div className="text-sm text-gray-500">
                          ë§ˆì§€ë§‰ ë°©ë¬¸: {formatDate(msg.lastVisit)} Â· ë°œì†¡ ì˜ˆì •: {formatDate(msg.scheduledAt)}
                        </div>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => onSend(msg.id)}
                        className="flex items-center gap-1 px-3 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700"
                      >
                        <Send size={16} />
                        ì¦‰ì‹œ ë°œì†¡
                      </button>
                      <button
                        onClick={() => onCancel(msg.id)}
                        className="flex items-center gap-1 px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300"
                      >
                        <X size={16} />
                        ì·¨ì†Œ
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </>
          )}
        </div>
      )}

      {/* ë°œì†¡ ì´ë ¥ */}
      {subTab === 'history' && (
        <div className="divide-y">
          {messages.length === 0 ? (
            <div className="p-8 text-center text-gray-500">ë°œì†¡ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>
          ) : (
            messages.map(msg => (
              <div key={msg.id} className="p-4 hover:bg-gray-50">
                <div className="flex items-start justify-between">
                  <div className="flex items-start gap-4">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                      msg.status === 'booked' ? 'bg-emerald-100' : 'bg-red-100'
                    }`}>
                      {msg.status === 'booked' ? (
                        <Check size={18} className="text-emerald-600" />
                      ) : (
                        <PhoneMissed size={18} className="text-red-600" />
                      )}
                    </div>
                    <div>
                      <div className="flex items-center gap-2 mb-1">
                        <span className="font-bold text-gray-900">{msg.patientName}</span>
                        <span className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">
                          {msg.treatment} {msg.timing}
                        </span>
                        <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                          msg.status === 'booked' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'
                        }`}>
                          {msg.status === 'booked' ? 'ì˜ˆì•½ì™„ë£Œ' : 'ë¯¸ì‘ë‹µ'}
                        </span>
                      </div>
                      <div className="text-sm text-gray-500 mb-1">{msg.patientPhone}</div>
                      <div className="text-sm text-gray-500">
                        ë°œì†¡: {msg.sentAt ? formatDate(msg.sentAt) : '-'}
                        {msg.status === 'booked' && msg.bookedAt && (
                          <span className="text-emerald-600 ml-2">â†’ {formatDate(msg.bookedAt)} ì˜ˆì•½</span>
                        )}
                        {msg.status === 'no-response' && msg.daysPassed && (
                          <span className="text-red-600 ml-2">â†’ {msg.daysPassed}ì¼ ê²½ê³¼</span>
                        )}
                      </div>
                    </div>
                  </div>
                  {msg.status === 'no-response' && (
                    <button
                      onClick={() => onCall(msg.patientPhone)}
                      className="flex items-center gap-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700"
                    >
                      <Phone size={16} />
                      ì „í™”í•˜ê¸°
                    </button>
                  )}
                </div>
              </div>
            ))
          )}
        </div>
      )}

      {/* ì „í™” í•„ìš” */}
      {subTab === 'call-needed' && (
        <div className="divide-y">
          {messages.filter(m => m.status === 'call-needed').length === 0 ? (
            <div className="p-8 text-center text-gray-500">ì „í™”ê°€ í•„ìš”í•œ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤</div>
          ) : (
            <>
              <div className="p-4 bg-red-50 flex items-center gap-3">
                <AlertCircle size={18} className="text-red-600" />
                <span className="text-sm text-red-700">
                  ì•Œë¦¼í†¡ ë°œì†¡ í›„ 3ì¼ ë‚´ ì˜ˆì•½ì´ ì—†ëŠ” í™˜ìì…ë‹ˆë‹¤. ì§ì ‘ ì „í™”í•´ì£¼ì„¸ìš”.
                </span>
              </div>
              {messages.filter(m => m.status === 'call-needed').map(msg => (
                <div key={msg.id} className="p-4 hover:bg-gray-50">
                  <div className="flex items-start justify-between">
                    <div className="flex items-start gap-4">
                      <div className="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                        <PhoneMissed size={18} className="text-red-600" />
                      </div>
                      <div>
                        <div className="flex items-center gap-2 mb-1">
                          <span className="font-bold text-gray-900">{msg.patientName}</span>
                          <span className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">
                            {msg.treatment} {msg.timing}
                          </span>
                          <span className="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs">
                            {msg.daysPassed}ì¼ ê²½ê³¼
                          </span>
                        </div>
                        <div className="text-sm text-gray-500 mb-1">{msg.patientPhone}</div>
                        <div className="text-sm text-gray-500">
                          ë°œì†¡ì¼: {msg.sentAt ? formatDate(msg.sentAt) : '-'}
                        </div>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => onCall(msg.patientPhone)}
                        className="flex items-center gap-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700"
                      >
                        <Phone size={16} />
                        ì „í™”
                      </button>
                      <button
                        onClick={() => onComplete(msg.id)}
                        className="flex items-center gap-1 px-3 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700"
                      >
                        <Check size={16} />
                        ì™„ë£Œ
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </>
          )}
        </div>
      )}
    </>
  );
}

// ê°ì‚¬ì¸ì‚¬ íƒ­ ì»´í¬ë„ŒíŠ¸
function ThanksTab({
  thanks,
  statusFilter,
  searchQuery,
  onStatusFilterChange,
  onSearchChange,
  onCall,
  onComplete,
}: {
  thanks: ThanksItem[];
  statusFilter: string;
  searchQuery: string;
  onStatusFilterChange: (status: CallbackStatus | 'all') => void;
  onSearchChange: (query: string) => void;
  onCall: (phone: string) => void;
  onComplete: (id: string, method: 'call' | 'message') => void;
}) {
  return (
    <>
      <div className="p-4 border-b flex items-center justify-between">
        <div className="flex items-center gap-2">
          {(['all', 'pending', 'completed'] as const).map(status => (
            <button
              key={status}
              onClick={() => onStatusFilterChange(status as CallbackStatus | 'all')}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                statusFilter === status
                  ? status === 'pending' ? 'bg-amber-500 text-white'
                    : status === 'completed' ? 'bg-emerald-500 text-white'
                    : 'bg-gray-900 text-white'
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              {status === 'all' ? 'ì „ì²´' : status === 'pending' ? 'ëŒ€ê¸°' : 'ì™„ë£Œ'}
            </button>
          ))}
        </div>

        <div className="relative">
          <Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
          <input
            type="text"
            value={searchQuery}
            onChange={(e) => onSearchChange(e.target.value)}
            placeholder="í™˜ìëª…, ì „í™”ë²ˆí˜¸ ê²€ìƒ‰"
            className="pl-10 pr-4 py-2 border rounded-lg text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
      </div>

      <div className="divide-y">
        {thanks.length === 0 ? (
          <div className="p-8 text-center">
            <Heart className="w-12 h-12 text-gray-300 mx-auto mb-3" />
            <p className="text-gray-500">ê°ì‚¬ì¸ì‚¬ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤</p>
          </div>
        ) : (
          thanks.map(item => (
            <div
              key={item.id}
              className={`p-4 hover:bg-gray-50 transition-colors ${
                item.status === 'completed' ? 'bg-gray-50 opacity-60' : ''
              }`}
            >
              <div className="flex items-start justify-between">
                <div className="flex items-start gap-4">
                  <div className="w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center">
                    <Heart size={24} className="text-rose-500" />
                  </div>

                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="font-bold text-gray-900">{item.referrerName}</span>
                      <span className="text-gray-400">ë‹˜ì´</span>
                      <span className="font-bold text-blue-600">{item.referredName}</span>
                      <span className="text-gray-400">ë‹˜ì„ ì†Œê°œí•´ì£¼ì…¨ì–´ìš”</span>
                      <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                        item.status === 'pending' ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'
                      }`}>
                        {item.status === 'pending' ? 'ëŒ€ê¸°' : 'ì™„ë£Œ'}
                      </span>
                    </div>
                    <div className="flex items-center gap-4 text-sm text-gray-500">
                      <span>ì†Œê°œì: {item.referrerPhone}</span>
                      <span>í”¼ì†Œê°œì: {item.referredPhone}</span>
                      <span>ì†Œê°œì¼: {item.referredAt.split('T')[0]}</span>
                    </div>
                    {item.note && (
                      <div className="text-sm text-gray-500 mt-2 flex items-center gap-1">
                        <MessageSquare size={14} />
                        {item.note}
                      </div>
                    )}
                  </div>
                </div>

                <div className="flex items-center gap-2">
                  {item.status === 'pending' && (
                    <>
                      <button
                        onClick={() => { onCall(item.referrerPhone); onComplete(item.id, 'call'); }}
                        className="flex items-center gap-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700"
                      >
                        <Phone size={16} />
                        ì „í™”
                      </button>
                      <button
                        onClick={() => onComplete(item.id, 'message')}
                        className="flex items-center gap-1 px-3 py-2 bg-rose-500 text-white rounded-lg text-sm font-medium hover:bg-rose-600"
                      >
                        <MessageSquare size={16} />
                        ë¬¸ì
                      </button>
                      <button
                        onClick={() => onComplete(item.id, 'call')}
                        className="flex items-center gap-1 px-3 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700"
                      >
                        <Check size={16} />
                        ì™„ë£Œ
                      </button>
                    </>
                  )}
                  {item.status === 'completed' && item.completedAt && (
                    <span className="text-sm text-gray-500">{item.completedAt.slice(0, 10)} ì™„ë£Œ</span>
                  )}
                </div>
              </div>
            </div>
          ))
        )}
      </div>
    </>
  );
}

// ì´ë²ˆ ì£¼ ìš”ì•½ ì»´í¬ë„ŒíŠ¸
function WeeklySummary() {
  const today = new Date();
  const dayOfWeek = today.getDay();
  const monday = new Date(today);
  monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

  const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
  const todayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

  return (
    <div className="bg-white rounded-xl border border-gray-100 p-4">
      <h3 className="font-bold text-gray-900 mb-4">ì´ë²ˆ ì£¼ ì¼ì • ìš”ì•½</h3>
      <div className="grid grid-cols-7 gap-2">
        {days.map((day, idx) => {
          const date = new Date(monday);
          date.setDate(monday.getDate() + idx);
          return (
            <div
              key={day}
              className={`text-center p-3 rounded-lg ${
                idx === todayIndex ? 'bg-blue-50 ring-2 ring-blue-500' : 'bg-gray-50'
              }`}
            >
              <div className="text-xs text-gray-500 mb-1">{day}</div>
              <div className="text-lg font-bold text-gray-900">{date.getDate()}</div>
              <div className="flex justify-center gap-1 mt-2">
                {idx <= todayIndex && <div className="w-2 h-2 bg-blue-500 rounded-full" title="ì½œë°±" />}
                {idx <= todayIndex && <div className="w-2 h-2 bg-purple-500 rounded-full" title="ë¦¬ì½œ" />}
                {idx === todayIndex && <div className="w-2 h-2 bg-rose-500 rounded-full" title="ê°ì‚¬ì¸ì‚¬" />}
              </div>
            </div>
          );
        })}
      </div>

      <div className="flex items-center gap-4 mt-4 text-xs text-gray-500">
        <span className="flex items-center gap-1">
          <div className="w-2 h-2 bg-blue-500 rounded-full" />
          ì½œë°±
        </span>
        <span className="flex items-center gap-1">
          <div className="w-2 h-2 bg-purple-500 rounded-full" />
          ë¦¬ì½œ
        </span>
        <span className="flex items-center gap-1">
          <div className="w-2 h-2 bg-rose-500 rounded-full" />
          ê°ì‚¬ì¸ì‚¬
        </span>
      </div>
    </div>
  );
}

// ============= Modals =============

// ì¼ì • ì¶”ê°€ ëª¨ë‹¬
function AddCallbackModal({ onClose, onSuccess }: { onClose: () => void; onSuccess: () => void }) {
  const [patientId, setPatientId] = useState('');
  const [type, setType] = useState<CallbackType>('callback');
  const [scheduledAt, setScheduledAt] = useState('');
  const [note, setNote] = useState('');
  const [patients, setPatients] = useState<Array<{ id: string; name: string; phone: string }>>([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [submitting, setSubmitting] = useState(false);

  useEffect(() => {
    const searchPatients = async () => {
      if (searchQuery.length < 2) {
        setPatients([]);
        return;
      }
      try {
        // period=allë¡œ ì „ì²´ í™˜ì ê²€ìƒ‰ (ê¸°ê°„ ì œí•œ ì—†ì´)
        const response = await fetch(`/api/v2/patients?search=${searchQuery}&limit=10&period=all`);
        const result = await response.json();
        // APIëŠ” { patients: [...], pagination: {...} } í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
        if (result.patients && result.patients.length > 0) {
          setPatients(result.patients.map((p: { id: string; name: string; phone: string }) => ({
            id: p.id, name: p.name, phone: p.phone,
          })));
        } else {
          setPatients([]);
        }
      } catch (error) {
        console.error('Failed to search patients:', error);
        setPatients([]);
      }
    };
    const debounce = setTimeout(searchPatients, 300);
    return () => clearTimeout(debounce);
  }, [searchQuery]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!patientId || !scheduledAt) {
      alert('í™˜ìì™€ ì˜ˆì • ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    setSubmitting(true);
    try {
      const response = await fetch('/api/v2/callbacks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ patientId, type, scheduledAt: new Date(scheduledAt).toISOString(), note }),
      });
      if (response.ok) {
        onSuccess();
      } else {
        const error = await response.json();
        alert(error.error || 'ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      console.error('Failed to create callback:', error);
      alert('ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setSubmitting(false);
    }
  };

  const TYPE_LABELS: Record<CallbackType, string> = { callback: 'ì½œë°±', recall: 'ë¦¬ì½œ', thanks: 'ê°ì‚¬ì „í™”' };
  const TYPE_COLORS: Record<CallbackType, string> = {
    callback: 'bg-blue-100 text-blue-700',
    recall: 'bg-purple-100 text-purple-700',
    thanks: 'bg-green-100 text-green-700',
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-white rounded-2xl w-full max-w-md p-6">
        <h2 className="text-xl font-bold text-gray-900 mb-4">ì¼ì • ì¶”ê°€</h2>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">í™˜ì ì„ íƒ</label>
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰"
              className="w-full border border-gray-200 rounded-lg px-3 py-2"
            />
            {patients.length > 0 && (
              <div className="mt-2 border border-gray-200 rounded-lg max-h-40 overflow-y-auto">
                {patients.map((patient) => (
                  <button
                    key={patient.id}
                    type="button"
                    onClick={() => { setPatientId(patient.id); setSearchQuery(`${patient.name} (${patient.phone})`); setPatients([]); }}
                    className="w-full px-3 py-2 text-left hover:bg-gray-50 text-sm"
                  >
                    {patient.name} Â· {patient.phone}
                  </button>
                ))}
              </div>
            )}
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">ì¼ì • íƒ€ì…</label>
            <div className="flex gap-2">
              {(['callback', 'recall', 'thanks'] as CallbackType[]).map((t) => (
                <button
                  key={t}
                  type="button"
                  onClick={() => setType(t)}
                  className={`flex-1 py-2 rounded-lg text-sm font-medium transition-colors ${
                    type === t ? TYPE_COLORS[t] : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  {TYPE_LABELS[t]}
                </button>
              ))}
            </div>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">ì˜ˆì • ì¼ì‹œ</label>
            <input
              type="datetime-local"
              value={scheduledAt}
              onChange={(e) => setScheduledAt(e.target.value)}
              className="w-full border border-gray-200 rounded-lg px-3 py-2"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">ë©”ëª¨</label>
            <textarea
              value={note}
              onChange={(e) => setNote(e.target.value)}
              rows={3}
              className="w-full border border-gray-200 rounded-lg px-3 py-2"
              placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
          <div className="flex gap-3 pt-2">
            <button type="button" onClick={onClose} className="flex-1 py-2 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
              ì·¨ì†Œ
            </button>
            <button type="submit" disabled={submitting} className="flex-1 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50">
              {submitting ? 'ì¶”ê°€ ì¤‘...' : 'ì¶”ê°€'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

// ì¹˜ë£Œ ì¶”ê°€ ëª¨ë‹¬
function AddTreatmentModal({ onClose, onAdd }: { onClose: () => void; onAdd: (treatment: string) => void }) {
  const [treatment, setTreatment] = useState('');

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!treatment.trim()) {
      alert('ì¹˜ë£Œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    onAdd(treatment.trim());
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-white rounded-2xl w-full max-w-sm p-6">
        <h2 className="text-xl font-bold text-gray-900 mb-4">ì¹˜ë£Œ ì¶”ê°€</h2>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">ì¹˜ë£Œëª…</label>
            <input
              type="text"
              value={treatment}
              onChange={(e) => setTreatment(e.target.value)}
              placeholder="ì˜ˆ: ìŠ¤ì¼€ì¼ë§, ì„í”Œë€íŠ¸, êµì •"
              className="w-full border border-gray-200 rounded-lg px-3 py-2"
              autoFocus
            />
          </div>
          <div className="flex gap-3 pt-2">
            <button type="button" onClick={onClose} className="flex-1 py-2 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50">
              ì·¨ì†Œ
            </button>
            <button type="submit" className="flex-1 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
              ì¶”ê°€
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

// ë°œì†¡ ì‹œì  í¸ì§‘ ëª¨ë‹¬
function EditScheduleModal({
  settingId,
  schedule,
  onClose,
  onSave,
}: {
  settingId: string;
  schedule?: RecallSchedule;
  onClose: () => void;
  onSave: (settingId: string, schedule: RecallSchedule, isNew: boolean) => void;
}) {
  const [timing, setTiming] = useState(schedule?.timing || '');
  const [timingDays, setTimingDays] = useState(schedule?.timingDays || 0);
  const [message, setMessage] = useState(schedule?.message || '');
  const isNew = !schedule;

  const handleTimingChange = (value: string) => {
    setTiming(value);
    const option = TIMING_OPTIONS.find(o => o.label === value);
    if (option) {
      setTimingDays(option.days);
    }
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!timing || !message.trim()) {
      alert('ë°œì†¡ ì‹œì ê³¼ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    onSave(settingId, {
      id: schedule?.id || '',
      timing,
      timingDays,
      message: message.trim(),
      enabled: schedule?.enabled ?? true,
    }, isNew);
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-white rounded-2xl w-full max-w-md p-6">
        <h2 className="text-xl font-bold text-gray-900 mb-4">{isNew ? 'ë°œì†¡ ì‹œì  ì¶”ê°€' : 'ë°œì†¡ ì‹œì  ìˆ˜ì •'}</h2>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">ë°œì†¡ ì‹œì </label>
            <select
              value={timing}
              onChange={(e) => handleTimingChange(e.target.value)}
              className="w-full border border-gray-200 rounded-lg px-3 py-2"
            >
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              {TIMING_OPTIONS.map(option => (
                <option key={option.label} value={option.label}>{option.label}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">ì•Œë¦¼í†¡ ë©”ì‹œì§€</label>
            <textarea
              value={message}
              onChange={(e) => setMessage(e.target.value)}
              rows={4}
              className="w-full border border-gray-200 rounded-lg px-3 py-2"
              placeholder="ë°œì†¡í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
          <div className="flex gap-3 pt-2">
            <button type="button" onClick={onClose} className="flex-1 py-2 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50">
              ì·¨ì†Œ
            </button>
            <button type="submit" className="flex-1 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
              {isNew ? 'ì¶”ê°€' : 'ì €ì¥'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

// Suspense ê²½ê³„ë¡œ ê°ì‹¸ì„œ export
export default function SchedulesPage() {
  return (
    <Suspense fallback={<div className="p-6 text-center text-gray-500">ë¡œë”© ì¤‘...</div>}>
      <SchedulesContent />
    </Suspense>
  );
}
