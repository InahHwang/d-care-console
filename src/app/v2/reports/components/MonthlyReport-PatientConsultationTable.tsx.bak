// src/app/v2/reports/components/MonthlyReport-PatientConsultationTable.tsx
// V2 환자별 상담 내용 요약 - 진행상황 가이드 + 테이블
'use client';

import React, { useState, useMemo } from 'react';
import { FileText, ChevronDown, ChevronUp } from 'lucide-react';
import type { MonthlyStatsV2, PatientSummaryV2 } from './MonthlyReport-Types';
import { PROGRESS_STAGE_CONFIG } from './MonthlyReport-Types';
import type { PatientStatus } from '@/types/v2';

interface MonthlyReportPatientConsultationTableProps {
  stats: MonthlyStatsV2;
  onPatientClick: (patient: PatientSummaryV2) => void;
}

// 진행상황 가이드 상수
const PROGRESS_GUIDE = [
  { stage: '전화상담', description: '첫 문의 후 아직 예약이 확정되지 않은 상태', detail: '콜백필요, 잠재고객, 부재중 등 예약 전 단계', status: 'consulting' as PatientStatus },
  { stage: '예약완료', description: '상담을 통해 내원 예약이 확정된 상태', detail: '예약일시가 정해져 내원을 기다리는 단계', status: 'reserved' as PatientStatus },
  { stage: '내원완료', description: '실제 병원에 내원하여 직접 상담을 받은 상태', detail: '내원 후 치료 여부가 아직 결정되지 않은 단계', status: 'visited' as PatientStatus },
  { stage: '치료예약', description: '내원 상담 후 치료 일정이 잡힌 상태', detail: '치료 계획에 동의하고 예약까지 완료된 단계', status: 'treatmentBooked' as PatientStatus },
  { stage: '치료중', description: '실제 치료가 진행 중인 상태', detail: '치료 과정이 시작되어 진행 중인 단계', status: 'treatment' as PatientStatus },
  { stage: '치료완료', description: '모든 치료가 완료된 상태', detail: '예정된 치료가 모두 끝난 단계', status: 'completed' as PatientStatus },
  { stage: '사후관리', description: '치료 후 관리가 진행 중인 상태', detail: '정기 검진, 추적 관찰 등의 단계', status: 'followup' as PatientStatus },
  { stage: '종결', description: '상담이나 치료가 완전히 종료된 상태', detail: '더 이상 진행할 내용이 없는 최종 단계', status: 'closed' as PatientStatus },
];

const MonthlyReportPatientConsultationTable: React.FC<MonthlyReportPatientConsultationTableProps> = ({
  stats,
  onPatientClick,
}) => {
  const [isExpanded, setIsExpanded] = useState(false);

  const patients = stats.patientSummaries || [];

  // 견적 합계
  const totalEstimated = useMemo(() =>
    patients.reduce((sum, p) => sum + (p.estimatedAmount || 0), 0),
    [patients]
  );
  const totalFinal = useMemo(() =>
    patients.reduce((sum, p) => sum + (p.finalAmount || 0), 0),
    [patients]
  );

  return (
    <div className="bg-white rounded-lg shadow-sm border mb-6">
      <div className="p-6 border-b bg-indigo-50">
        <div className="flex items-center justify-between">
          <h2 className="text-lg font-bold text-gray-900 flex items-center gap-2">
            <FileText className="w-5 h-5 text-indigo-600" />
            환자별 상담 내용 요약
            <span className="text-sm bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full">
              {patients.length}명
            </span>
          </h2>
          <button
            onClick={() => setIsExpanded(!isExpanded)}
            className="flex items-center gap-1 px-3 py-1 text-sm text-indigo-600 border border-indigo-200 rounded-lg hover:bg-indigo-50 no-print"
          >
            {isExpanded ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
            {isExpanded ? '접기' : '펼치기'}
          </button>
        </div>
      </div>

      <div className="p-6">
        {/* 진행상황 가이드 */}
        <div className="mb-6 p-4 bg-slate-50 border border-slate-200 rounded-lg">
          <div className="flex items-center gap-2 mb-4">
            <div className="w-5 h-5 bg-indigo-600 rounded-full flex items-center justify-center">
              <span className="text-white text-xs font-bold">?</span>
            </div>
            <h3 className="text-sm font-semibold text-slate-900">
              환자 진행상황 가이드
            </h3>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
            {PROGRESS_GUIDE.map((guide, index) => {
              const config = PROGRESS_STAGE_CONFIG[guide.status];
              return (
                <div
                  key={guide.status}
                  className={`p-3 rounded-lg border-2 ${config.bgColor} border-opacity-50`}
                  style={{ borderColor: 'currentColor' }}
                >
                  <div className="flex items-center gap-2 mb-2">
                    <span className="text-xs font-bold text-slate-500">{index + 1}.</span>
                    <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${config.color} ${config.bgColor}`}>
                      {guide.stage}
                    </span>
                    {stats.progressStats[guide.status] > 0 && (
                      <span className="text-xs font-bold text-slate-700">
                        ({stats.progressStats[guide.status]}명)
                      </span>
                    )}
                  </div>
                  <p className="text-xs text-slate-700 font-medium mb-1">{guide.description}</p>
                  <p className="text-xs text-slate-600">{guide.detail}</p>
                </div>
              );
            })}
          </div>
        </div>

        {/* 진행상황별 요약 */}
        <div className="flex flex-wrap gap-2 mb-4">
          {PROGRESS_GUIDE.map((guide) => {
            const count = stats.progressStats[guide.status] || 0;
            if (count === 0) return null;
            const config = PROGRESS_STAGE_CONFIG[guide.status];
            return (
              <span key={guide.status} className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${config.color} ${config.bgColor}`}>
                {guide.stage}: {count}명
              </span>
            );
          })}
        </div>

        {/* 환자 테이블 */}
        {isExpanded && (
          <>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b bg-gray-50">
                    <th className="px-3 py-2 text-left font-medium text-gray-700">이름</th>
                    <th className="px-3 py-2 text-left font-medium text-gray-700">연령</th>
                    <th className="px-3 py-2 text-left font-medium text-gray-700">관심분야</th>
                    <th className="px-3 py-2 text-left font-medium text-gray-700">상담내용</th>
                    <th className="px-3 py-2 text-right font-medium text-gray-700">견적금액</th>
                    <th className="px-3 py-2 text-center font-medium text-gray-700">진행상황</th>
                  </tr>
                </thead>
                <tbody>
                  {patients.map((patient) => {
                    const config = PROGRESS_STAGE_CONFIG[patient.status];
                    return (
                      <tr
                        key={patient.patientId}
                        onClick={() => onPatientClick(patient)}
                        className="border-b hover:bg-blue-50 cursor-pointer transition-colors"
                      >
                        <td className="px-3 py-3">
                          <div className="font-medium text-gray-900">{patient.name}</div>
                          {patient.gender && (
                            <div className="text-xs text-gray-500">{patient.gender}</div>
                          )}
                        </td>
                        <td className="px-3 py-3 text-gray-600">
                          {patient.age ? `${patient.age}세` : '-'}
                        </td>
                        <td className="px-3 py-3 text-gray-600">
                          {patient.interest || '-'}
                        </td>
                        <td className="px-3 py-3 text-gray-600 max-w-xs">
                          <div className="truncate">
                            {patient.consultationSummary || '-'}
                          </div>
                        </td>
                        <td className="px-3 py-3 text-right text-gray-900">
                          {patient.estimatedAmount > 0
                            ? `${patient.estimatedAmount.toLocaleString()}원`
                            : '-'}
                        </td>
                        <td className="px-3 py-3 text-center">
                          <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${config.color} ${config.bgColor}`}>
                            {config.label}
                          </span>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>

            {/* 견적 합계 */}
            <div className="mt-4 flex justify-end gap-6 text-sm">
              <div className="text-gray-600">
                예상 합계: <span className="font-bold text-gray-900">{totalEstimated.toLocaleString()}원</span>
              </div>
              <div className="text-gray-600">
                확정 합계: <span className="font-bold text-blue-700">{totalFinal.toLocaleString()}원</span>
              </div>
            </div>
          </>
        )}

        {!isExpanded && patients.length > 0 && (
          <p className="text-sm text-gray-400 text-center">
            &apos;펼치기&apos; 버튼을 눌러 환자별 상세 내용을 확인하세요.
          </p>
        )}
      </div>
    </div>
  );
};

export default MonthlyReportPatientConsultationTable;
